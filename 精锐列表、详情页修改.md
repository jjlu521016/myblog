# 精锐列表、详情页修改方案及评估  -卢杰 2018-08
**<font color="#FF0000">本方案的原则是尽量少改动代码来实现功能，方便代码回滚及其他应急准备</font>**

## 一、 详情页
旧逻辑如图所示：
<img src="C:\Users\jjlu5\Desktop\detail.png"  />

由上图可以看出，当浏览器跳转到商品详情页面的时候，后台就开始根据区id处理相应的货品。  
目前首页已经取出的数据如下：  
+ 选中的城市id、城市名称(目前放到localStorage)

**<font color="#FF0000">如果按照在首页选择城市之后来构建区域与商品的模型对象，有以下问题</font>**：  
+ 代码改动量很大，还需要考虑商品数据的一致性（价格等其他信息）
+ 根据目前线上的城市数据来看，配置的仓库城市很多。会造成大量的数据在缓存中同时造成数据不一致
+ 对详情页商品的收藏及其他操作都会有数据不一致的影响
+ 首页操作需要存储省市数据，对首页缓存的结构需要修改，导致首页代码大量修改
+ 进入商品详情页和搜索列表的逻辑全部打乱，并且可能会引入新的问题
+ 对于搜索页面，根据品牌、关键字、分类等搜索的相关代码都需要修改逻辑
+ 封死详情页、搜索页面的省市选项。前端代码几乎需要重构
+ 工作量很大很大

### 建议方案:
首页现在城市数据采用 cookie+ localStorage同时更新的方式:  
cookie主要用来记录ip获取到的地址  
localStorage用来存放城市对象数据  
<img src="C:\Users\jjlu5\Desktop\index.png"  />

为了使代码改动最小，现在方案如下：  

+ 1.首页在根据城市获取当前城市的商品价格的过程中，异步将当前城市默认第一个区id存入到session。 
这样一来就打通了商品详情页和列表页默认加载区id不一致的问题
+ 2.之后根据区id走之前的逻辑
+ 2.1 后台：
 要在进入页面时候做下相应的区id处理。例如，货品在当前地区没有查到数据，则重新从后台默认地址取出当前货品的数据(这种情况不会存在或者下架？？)。
+ 2.2 前端: 根据实际情况做下代码调整
eg. 前端根据区id获取地址数据的时候，将城市数据更新到首页存储的localStorage和cookie中。  

整体对比如下:
<img src="C:\Users\jjlu5\Desktop\detail-diff.png"  />

### 可能影响到的功能：
+ 商品详情页的到货通知（不知道精锐有没有这个功能）
+ 收藏商品
+ 区域设置与搜索列表页相关联

### 商品列表页同详情页方案(略)

### 工作量评估
改动类型 | 内容 | 工时(小时)
---- | --- | ---
PC端首页商品价格 | 首页商品价格不一致需要走营销插件计算 | 5
H5/PC首页数据存储 | 首页区id存入到session | 2
H5/PC商品详情页 | 地区处理及更新相应的缓存数据 | 8
H5/PC搜索列表页 | 地区处理及更新相应的缓存数据 | 4
H5/PC功能测试 | 修改涉及到的功能全局测试 | 8
合计工时: 27工时